{% extends "base.html" %}
{% load i18n %}

{% block content %}
{% if request.user.is_authenticated %}
<div class="container mt-5">
  <div class="col-md-12">
    <div class="jumbotron">
      <div class="container">
        <h1 class="display-4">Hello {{Â request.user.oidc_user.userinfo.given_name }}!</h1>
        <p class="lead">{% trans "Your e-mail address is:" %} <strong>{{ request.user.oidc_user.userinfo.email }}</strong></p>
      </div>
    </div>
  </div>
</div>
{% else %}
<p> not authenticated</p>
{% endif %}
 <h1>Implicit Flow Test Callback</h1>

        <div id="retrievedInfo">
            id_token claims and userinfo not found.
</div>
{% endblock content %}


{% block additionnal_script %}
     <script>
            OIDC.restoreInfo();
            var id_token = OIDC.getValidIdToken();
            var access_token = OIDC.getAccessToken();


            // From http://openid.net/specs/openid-connect-core-1_0.html Section 15.5.3
            // First, parse the query string
            var params = {}
            var postBody = location.hash.substring(1);
            var regex = /([^&=]+)=([^&]*)/g, m;
            while (m = regex.exec(postBody)) {
              params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            postBody += '&nonce=' + sessionStorage.getItem('nonce');

            // And send the token over to the server
            var req = new XMLHttpRequest();
            // using POST so query isn't logged
            req.open('POST', 'http://' + window.location.host +'/catch_response/', true);
            req.setRequestHeader('Content-Type',
                                 'application/x-www-form-urlencoded');
            req.responseType = "json";
            req.onreadystatechange = function (e) {
              if (req.readyState === XMLHttpRequest.DONE) {
                if (req.status === 200) {
            // If the response from the POST is 200 OK, perform a redirect
                  var tokenClaims = JSON.parse(OIDC.getIdTokenParts(id_token)[1]);
                  var userInfoClaims = JSON.parse(OIDC.getUserInfo(access_token));
                  var tokenClaimsHTMLString = JSONObjToHTMLTable(tokenClaims);
                  var userInfoClaimsHTMLString = JSONObjToHTMLTable(userInfoClaims);

                  OIDC.debug(true, id_token);
                  document.getElementById("retrievedInfo").innerHTML = '<b>Id_token</b>' + tokenClaimsHTMLString +
                                                                      '\n<b>User Info</b>' + userInfoClaimsHTMLString;
                  sessionStorage.removeItem('state');
                  sessionStorage.removeItem('nonce');

                  console.log('from back');
                  console.log(req.response);
                  $.ajax({
                    url: "http://localhost:8081/user",
                    type: "GET",
                    beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'Bearer '+access_token);},
                    success: function(data) { console.log('FROM JS');console.log(data); }
                  });
                }
            // if the OAuth response is invalid, generate an error message
                else if (req.status == 400) {
                  alert('There was an error processing the token')
                } else {
                  alert('Something other than 200 was returned')
                }
              }
            };

            req.send(postBody);
        </script>
{% endblock additionnal_script %}
